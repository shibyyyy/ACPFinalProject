{%extends 'base.html'%}
{%block title%}<title>Multiple Choice - VocabuLearner</title>{% endblock%}

{%block content%}
    {%block logo_link %}
            <a href="{{ url_for('dashboard') }}" class="logo-link">
                <div class="logo-icon">
                    <div class="pokeball-mini"></div>
                    <div class="pokeball-mini"></div>
                    <div class="pokeball-mini"></div>
                </div>
                VocabuLearner
            </a>
    {% endblock %}
    {%block header%}{%endblock%}
<main class="game-container">
        <!-- Game Header -->
        <div class="game-header">
            <div class="game-title">Word Matching Challenge</div>
            <div class="game-stats">
                <div class="stat-box">
                    <div class="stat-value" id="score">0</div>
                    <div class="stat-label">Score</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="matches">0/6</div>
                    <div class="stat-label">Matches</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="time">02:00</div>
                    <div class="stat-label">Time</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="streak">0</div>
                    <div class="stat-label">Streak</div>
                </div>
            </div>
        </div>

        <!-- Game Info -->
        <div class="game-info">
            <div class="instructions">
                <strong>HOW TO PLAY:</strong> Match each WORD on the left with its correct DEFINITION on the right. Select one word and one definition to make a match. Get combos for consecutive matches!
            </div>
            <div class="game-mode">
                <div class="mode-badge">TIMED MODE</div>
                <div class="mode-badge" style="background: #2196F3;">6 PAIRS</div>
            </div>
        </div>

        <!-- Matching Grid -->
        <div class="matching-grid">
            <!-- Words Column -->
            <div class="words-column">
                <div class="column-title">üìö WORDS</div>
                <div id="words-container">
                    <!-- Word cards will be populated by JavaScript -->
                </div>
            </div>

            <!-- Definitions Column -->
            <div class="definitions-column">
                <div class="column-title">üìñ DEFINITIONS</div>
                <div id="definitions-container">
                    <!-- Definition cards will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Combo Display -->
        <div class="combo-display" id="combo-display"></div>

        <!-- Game Controls -->
        <div class="game-controls">
            <button class="control-btn secondary" onclick="restartGame()">
                üîÅ Restart Game
            </button>
        </div>
    </main>

    <!-- Score Popup -->
    <div class="score-popup" id="score-popup">
        <div class="score-title">Game Complete!</div>
        <div class="score-result">Score: <span id="final-score">0</span></div>
        
        <div class="score-stats">
            <div class="score-stat">
                <div class="score-stat-value" id="final-matches">0/6</div>
                <div class="score-stat-label">Matches</div>
            </div>
            <div class="score-stat">
                <div class="score-stat-value" id="final-time">00:00</div>
                <div class="score-stat-label">Time Left</div>
            </div>
            <div class="score-stat">
                <div class="score-stat-value" id="final-combo">0x</div>
                <div class="score-stat-label">Best Combo</div>
            </div>
            <div class="score-stat">
                <div class="score-stat-value" id="final-accuracy">0%</div>
                <div class="score-stat-label">Accuracy</div>
            </div>
        </div>
        
        <div style="display: flex; gap: 20px; justify-content: center;">
            <button class="control-btn" onclick="restartGame()">
                üîÑ Play Again
            </button>
            <button class="control-btn secondary" onclick="closePopup()">
                Back to Menu
            </button>
        </div>
    </div>

    <footer class="footer">
        <p>¬© 2025 VocabuLearner - Collect Words, Master Languages, Achieve Greatness</p>
        <p style="margin-top: 10px; font-size: 8px;">Word Matching Game - Connect words with their meanings!</p>
    </footer>

    <script>
        // Game Data
        const wordPairs = [
            {
                word: "Eloquent",
                definition: "Fluent or persuasive in speaking or writing"
            },
            {
                word: "Resilient",
                definition: "Able to withstand or recover quickly from difficult conditions"
            },
            {
                word: "Meticulous",
                definition: "Showing great attention to detail; very careful and precise"
            },
            {
                word: "Pragmatic",
                definition: "Dealing with things sensibly and realistically"
            },
            {
                word: "Aesthetic",
                definition: "Concerned with beauty or the appreciation of beauty"
            },
            {
                word: "Empathy",
                definition: "The ability to understand and share the feelings of another"
            }
        ];

        // Game State
        let gameState = {
            score: 0,
            matches: 0,
            totalPairs: 6,
            currentCombo: 0,
            bestCombo: 0,
            timeLeft: 120, // 2 minutes in seconds
            selectedWord: null,
            selectedDefinition: null,
            matchedPairs: [],
            incorrectAttempts: 0,
            gameActive: true
        };

        // DOM Elements
        const wordsContainer = document.getElementById('words-container');
        const definitionsContainer = document.getElementById('definitions-container');
        const comboDisplay = document.getElementById('combo-display');
        const scoreElement = document.getElementById('score');
        const matchesElement = document.getElementById('matches');
        const timeElement = document.getElementById('time');
        const streakElement = document.getElementById('streak');
        const scorePopup = document.getElementById('score-popup');
        let timerInterval;

        // Initialize Game
        function initGame() {
            resetGameState();
            setupGameBoard();
            startTimer();
            updateDisplay();
        }

        // Reset Game State
        function resetGameState() {
            gameState = {
                score: 0,
                matches: 0,
                totalPairs: 6,
                currentCombo: 0,
                bestCombo: 0,
                timeLeft: 120,
                selectedWord: null,
                selectedDefinition: null,
                matchedPairs: [],
                incorrectAttempts: 0,
                gameActive: true
            };
        }

        // Setup Game Board
        function setupGameBoard() {
            // Clear containers
            wordsContainer.innerHTML = '';
            definitionsContainer.innerHTML = '';
            
            // Shuffle words and definitions separately
            const shuffledWords = [...wordPairs].sort(() => Math.random() - 0.5);
            const shuffledDefinitions = [...wordPairs].sort(() => Math.random() - 0.5);
            
            // Create word cards
            shuffledWords.forEach((pair, index) => {
                const wordCard = document.createElement('div');
                wordCard.className = 'word-card';
                wordCard.dataset.id = pair.word;
                wordCard.innerHTML = `
                    <div class="card-content">${pair.word}</div>
                `;
                wordCard.onclick = () => selectCard('word', pair.word, wordCard);
                wordsContainer.appendChild(wordCard);
            });
            
            // Create definition cards
            shuffledDefinitions.forEach((pair, index) => {
                const definitionCard = document.createElement('div');
                definitionCard.className = 'definition-card';
                definitionCard.dataset.id = pair.word;
                definitionCard.innerHTML = `
                    <div class="card-content">${pair.definition}</div>
                `;
                definitionCard.onclick = () => selectCard('definition', pair.word, definitionCard);
                definitionsContainer.appendChild(definitionCard);
            });
        }

        // Select Card
        function selectCard(type, id, element) {
            if (!gameState.gameActive || gameState.matchedPairs.includes(id)) return;
            
            if (type === 'word') {
                // Deselect previous word selection
                if (gameState.selectedWord) {
                    document.querySelector(`.word-card[data-id="${gameState.selectedWord}"]`).classList.remove('selected');
                }
                
                // Select new word
                gameState.selectedWord = id;
                element.classList.add('selected');
                
            } else {
                // Deselect previous definition selection
                if (gameState.selectedDefinition) {
                    document.querySelector(`.definition-card[data-id="${gameState.selectedDefinition}"]`).classList.remove('selected');
                }
                
                // Select new definition
                gameState.selectedDefinition = id;
                element.classList.add('selected');
            }
            
            // If we have both selected, check match
            if (gameState.selectedWord && gameState.selectedDefinition) {
                setTimeout(() => checkMatch(), 300);
            }
        }

        // Check Match
        function checkMatch() {
            if (!gameState.selectedWord || !gameState.selectedDefinition) return;
            
            const wordCard = document.querySelector(`.word-card[data-id="${gameState.selectedWord}"]`);
            const definitionCard = document.querySelector(`.definition-card[data-id="${gameState.selectedDefinition}"]`);
            
            if (gameState.selectedWord === gameState.selectedDefinition) {
                // Correct match
                handleCorrectMatch(wordCard, definitionCard);
            } else {
                // Incorrect match
                handleIncorrectMatch(wordCard, definitionCard);
            }
            
            // Update display
            updateDisplay();
        }

        // Handle Correct Match
        function handleCorrectMatch(wordCard, definitionCard) {
            // Mark as matched
            wordCard.classList.remove('selected');
            definitionCard.classList.remove('selected');
            wordCard.classList.add('matched');
            definitionCard.classList.add('matched');
            
            // Add to matched pairs
            gameState.matchedPairs.push(gameState.selectedWord);
            
            // Update score
            const basePoints = 50;
            const comboBonus = gameState.currentCombo * 10;
            const timeBonus = Math.floor(gameState.timeLeft / 10);
            const totalPoints = basePoints + comboBonus + timeBonus;
            
            gameState.score += totalPoints;
            gameState.matches++;
            gameState.currentCombo++;
            
            if (gameState.currentCombo > gameState.bestCombo) {
                gameState.bestCombo = gameState.currentCombo;
            }
            
            // Show combo display
            if (gameState.currentCombo > 1) {
                showCombo(gameState.currentCombo);
            }
            
            // Check if game is complete
            if (gameState.matches === gameState.totalPairs) {
                setTimeout(() => endGame(), 500);
            }
            
            // Reset selections
            gameState.selectedWord = null;
            gameState.selectedDefinition = null;
        }

        // Handle Incorrect Match
        function handleIncorrectMatch(wordCard, definitionCard) {
            gameState.incorrectAttempts++;
            gameState.currentCombo = 0;
            
            wordCard.classList.add('incorrect');
            definitionCard.classList.add('incorrect');
            
            // Reset after delay
            setTimeout(() => {
                wordCard.classList.remove('selected', 'incorrect');
                definitionCard.classList.remove('selected', 'incorrect');
                gameState.selectedWord = null;
                gameState.selectedDefinition = null;
            }, 1000);
        }

        // Show Combo
        function showCombo(combo) {
            const comboTexts = [
                "GOOD!",
                "GREAT!",
                "AWESOME!",
                "AMAZING!",
                "UNSTOPPABLE!",
                "LEGENDARY!"
            ];
            
            const text = comboTexts[Math.min(combo - 2, comboTexts.length - 1)] || "INCREDIBLE!";
            comboDisplay.textContent = `${text} ${combo}x COMBO!`;
            comboDisplay.classList.add('show');
            
            setTimeout(() => {
                comboDisplay.classList.remove('show');
            }, 1000);
        }

        // Timer Functions
        function startTimer() {
            updateTimerDisplay();
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (!gameState.gameActive) {
                    clearInterval(timerInterval);
                    return;
                }
                
                gameState.timeLeft--;
                updateTimerDisplay();
                
                if (gameState.timeLeft <= 30) {
                    // Visual warning for low time
                    const timeElement = document.querySelector('.stat-box:nth-child(3) .stat-value');
                    timeElement.style.color = '#ff4444';
                    timeElement.style.animation = 'pulse 1s infinite';
                }
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            timeElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Update Display
        function updateDisplay() {
            scoreElement.textContent = gameState.score;
            matchesElement.textContent = `${gameState.matches}/${gameState.totalPairs}`;
            streakElement.textContent = gameState.currentCombo;
        }

        // End Game
        function endGame() {
            gameState.gameActive = false;
            clearInterval(timerInterval);
            
            // Calculate accuracy
            const totalAttempts = gameState.matches + gameState.incorrectAttempts;
            const accuracy = totalAttempts > 0 ? Math.round((gameState.matches / totalAttempts) * 100) : 0;
            
            // Update final score display
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('final-matches').textContent = `${gameState.matches}/${gameState.totalPairs}`;
            document.getElementById('final-time').textContent = timeElement.textContent;
            document.getElementById('final-combo').textContent = `${gameState.bestCombo}x`;
            document.getElementById('final-accuracy').textContent = `${accuracy}%`;
            
            // Show score popup after delay
            setTimeout(() => {
                scorePopup.classList.add('show');
            }, 1000);
        }

        // Restart Game
        function restartGame() {
            scorePopup.classList.remove('show');
            initGame();
        }

        // Close Popup
        function closePopup() {
            scorePopup.classList.remove('show');
            // In a real app, this would navigate back to challenges
            alert('Returning to challenges menu...');
        }

        // Initialize game when page loads
        window.onload = initGame;
    </script>
{%endblock%}