{% extends 'base.html' %}

{% block title %}<title>VocabuLearner - Add Words</title>{% endblock %}

{% block content %}
    {% block logo_link %}
        <a href="{{ url_for('dashboard') }}" class="logo-link">
            <div class="logo-icon">
                <div class="pokeball-mini"></div>
                <div class="pokeball-mini"></div>
                <div class="pokeball-mini"></div>
            </div>
            VocabuLearner
        </a>
    {% endblock %}
    {% block header %}{% endblock %}
    {{ form.hidden_tag() }}

    <!-- WORD ENTRY FORM -->
    <div class="container" id="wordEntry">
        <h1>Add Your Words</h1>
       
        <!-- PokÃ©mon Evolution Area -->
        <div class="pokemon-evolution">
            <h3 class="section-title">Your Vocabulary Partner</h3>
            
            <div class="pokemon-container">
                <div class="pokemon-card" id="currentPokemon">
                    {% if current_pokemon %}
                        <div class="pokemon-main">
                            <div class="pokemon-image-container">
                                <img src="{{ current_pokemon.url }}" class="pokemon-sprite-large" alt="{{ current_pokemon.name }}">
                            </div>
                            
                            <div class="pokemon-details">
                                <div class="pokemon-name-large">
                                    {{ user.pokemon_name or current_pokemon.name }}
                                </div>
                                
                                <div class="pokemon-stats-compact">
                                    <div class="stats-row">
                                        <span class="stat-label">PokÃ©mon</span>
                                        <span class="stat-value">{{ current_pokemon.name }}</span>
                                        <span class="stat-separator">|</span>
                                        <span class="stat-label">EXP</span>
                                        <span class="stat-value">{{ user.total_points or 0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="no-pokemon">
                            <div class="pokeball-placeholder">âšª</div>
                            <p class="no-pokemon-text">No PokÃ©mon selected!</p>
                            <a href="{{ url_for('dashboard') }}" class="btn-select-pokemon">Select PokÃ©mon</a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            {% if current_pokemon %}
                <div class="evolution-progress">
                    {% if progress_data and not progress_data.is_max_evolution %}
                        <div class="progress-header">
                            <h4 class="progress-title">Evolution Progress</h4>
                            <span class="progress-count">{{ progress_data.progress_points|int }}/{{ progress_data.total_needed }}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ progress_data.progress_percentage|int }}%"></div>
                        </div>
                        <p class="progress-remaining">{{ progress_data.exp_to_next }} EXP to evolve into {{ progress_data.next_evolution }}</p>
                    {% elif progress_data and progress_data.is_max_evolution %}
                        <div class="progress-header">
                            <h4 class="progress-title">Maximum Evolution Reached!</h4>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                        <p class="progress-remaining">Your {{ current_pokemon.name }} is fully evolved! ðŸŽ‰</p>
                    {% else %}
                        <div class="progress-header">
                            <h4 class="progress-title">Evolution Progress</h4>
                            <span class="progress-count">0/100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <p class="progress-remaining">100 EXP to next evolution</p>
                    {% endif %}
                </div>
            {% else %}
                <p class="selection-prompt">Select a PokÃ©mon partner from your dashboard!</p>
            {% endif %}
        </div>
       
        <!-- Connect inputs to Flask-WTF AddWordForm -->
        <form class="word-form" id="wordForm" method="POST" action="{{ url_for('add_word') }}">
            {{ form.hidden_tag() }}
           
            <input type="text" placeholder="Word" id="wordInput" name="word" required />
           
            <textarea placeholder="Definition" id="meaningInput" name="definition" rows="3" required></textarea>
           
            <textarea placeholder="Example Sentence" id="exampleInput" name="sentence" rows="3" required></textarea>
           
            <!-- Part of Speech / Category -->
            <select id="categoryInput" name="category" class="word-input" required>
                <option value="">Select Category</option>
                <option value="noun">Noun</option>
                <option value="verb">Verb</option>
                <option value="adjective">Adjective</option>
                <option value="adverb">Adverb</option>
            </select>
           
            <button type="submit" class="btn-primary" id="addWordBtn">Add Word</button>
        </form>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <p>Â© 2025 VocabuLearner</p>
    </footer>

    <script>
    // DOM Elements
    const wordForm = document.getElementById('wordForm');
    const wordInput = document.getElementById('wordInput');
    const meaningInput = document.getElementById('meaningInput');
    const categoryInput = document.getElementById('categoryInput');
    
    // Debounce variables
    let debounceTimer;
    const DEBOUNCE_DELAY = 800; // 800ms delay for better validation
    
    // Store original placeholder
    const originalPlaceholder = meaningInput.placeholder;
    
    // Last fetched word to avoid duplicate API calls
    let lastFetchedWord = '';

    // Fetch meaning from DictionaryAPI with better error handling
    async function fetchWordData(word) {
        // Don't fetch if it's the same word we just fetched
        if (word.toLowerCase() === lastFetchedWord.toLowerCase()) {
            return;
        }
        
        // Show loading state
        meaningInput.placeholder = "Fetching definition...";
        meaningInput.value = "";
        categoryInput.value = "";
        
        try {
            const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
            
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error("Word not found in dictionary");
                } else {
                    throw new Error(`API error: ${response.status}`);
                }
            }
            
            const data = await response.json();
            
            if (!data || data.length === 0) {
                throw new Error("No dictionary data found");
            }

            const entry = data[0];
            const meaningBlock = entry.meanings?.[0];
            const definitionBlock = meaningBlock?.definitions?.[0];

            const definition = definitionBlock?.definition || "No definition found";
            let partOfSpeech = meaningBlock?.partOfSpeech || "";

            // Normalize to lowercase so it matches <select> options
            partOfSpeech = partOfSpeech.toLowerCase();

            // Autoâ€‘fill definition
            meaningInput.value = definition;
            
            // Set category if it matches our options
            const validCategories = ['noun', 'verb', 'adjective', 'adverb'];
            if (validCategories.includes(partOfSpeech)) {
                categoryInput.value = partOfSpeech;
            } else {
                categoryInput.value = "";
            }
            
            // Store the successfully fetched word
            lastFetchedWord = word;
            
        } catch (error) {
            console.error('Dictionary API error:', error);
            
            if (error.message.includes('Word not found') || error.message.includes('404')) {
                meaningInput.value = "Word not found. Please check spelling or enter manually.";
            } else if (error.message.includes('API error')) {
                meaningInput.value = "Dictionary service unavailable. Please enter manually.";
            } else {
                meaningInput.value = "Unable to fetch definition. Please enter manually.";
            }
            
            categoryInput.value = "";
            lastFetchedWord = ''; // Reset on error
        } finally {
            // Restore placeholder
            meaningInput.placeholder = originalPlaceholder;
        }
    }

    // Validate if word looks like a real English word
    function isValidEnglishWord(word) {
        // Basic validation - at least 2 letters
        if (word.length < 2) return false;
        
        // Should contain only letters, apostrophes, or hyphens
        if (!/^[a-zA-Z]+(?:['-][a-zA-Z]+)*$/.test(word)) return false;
        
        // Shouldn't be all caps (except for short words like "I")
        if (word.length > 1 && word === word.toUpperCase()) return false;
        
        return true;
    }

    // Debounced input listener with validation
    wordInput.addEventListener("input", function() {
        const word = this.value.trim();
        
        // Clear previous timer
        clearTimeout(debounceTimer);
        
        // Reset if empty
        if (word === '') {
            meaningInput.value = '';
            categoryInput.value = '';
            meaningInput.placeholder = originalPlaceholder;
            lastFetchedWord = '';
            return;
        }
        
        // Basic length check
        if (word.length < 3) {
            meaningInput.value = "Enter at least 3 characters";
            categoryInput.value = "";
            return;
        }
        
        // Validate it's a potential English word
        if (!isValidEnglishWord(word)) {
            meaningInput.value = "Please enter a valid English word";
            categoryInput.value = "";
            return;
        }
        
        // Set debounce timer - only fetch after user stops typing
        debounceTimer = setTimeout(() => {
            fetchWordData(word);
        }, DEBOUNCE_DELAY);
    });

    // Clear timer when user leaves the field
    wordInput.addEventListener("blur", function() {
        clearTimeout(debounceTimer);
    });

    // Submit handler with better validation
    wordForm.addEventListener("submit", function(e) {
        const word = wordInput.value.trim();
        const meaning = meaningInput.value.trim();
        const example = document.getElementById("exampleInput").value.trim();
        const category = categoryInput.value;

        // Validation
        let errorMessage = '';
        
        if (!word) errorMessage = "Please enter a word";
        else if (!meaning) errorMessage = "Please enter a definition";
        else if (!example) errorMessage = "Please enter an example sentence";
        else if (!category) errorMessage = "Please select a category";
        else if (meaning.includes("Word not found") || 
                 meaning.includes("Please enter") || 
                 meaning.includes("Dictionary service") ||
                 meaning.includes("Unable to fetch")) {
            errorMessage = "Please enter a valid definition for the word";
        }
        
        if (errorMessage) {
            alert(errorMessage);
            e.preventDefault();
            return;
        }
        
        // Show success animation for PokÃ©mon if exists
        const pokemonSprite = document.querySelector('.pokemon-sprite-large');
        if (pokemonSprite) {
            pokemonSprite.classList.add('animate-pulse');
            setTimeout(() => {
                pokemonSprite.classList.remove('animate-pulse');
            }, 1000);
        }
    });

    // Allow manual editing of definition without triggering API
    meaningInput.addEventListener('focus', function() {
        clearTimeout(debounceTimer);
    });
    
    // Prevent form from being submitted with Enter key in textareas
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                // Allow Ctrl+Enter for new lines
                return;
            }
        });
    });
    </script>

{% endblock %}