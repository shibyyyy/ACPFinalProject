{% extends 'base.html' %}


{% block title %}<title>VocabuLearner</title>{% endblock %}


{% block content %}
    {% block logo_link %}
        <a href="{{ url_for('dashboard') }}" class="logo-link">
            <div class="logo-icon">
                <div class="pokeball-mini"></div>
                <div class="pokeball-mini"></div>
                <div class="pokeball-mini"></div>
            </div>
            VocabuLearner
        </a>
    {% endblock %}
    {% block header %}
    <div class="header-actions">
        <button class="logout-btn" onclick="window.location.href='/'">Logout</button>
    </div>
    {% endblock %}


    <div class="right-buttons">
        <!-- Profile Button -->
        <div class="profile-btn" onclick="window.location.href='/profile'">
            <div class="profile-icon">üë§</div>
        </div>
        <!-- Notification Button -->
        <div class="notification-btn" onclick="toggleNotifications()">
            <div class="notification-bell-icon">üîî</div>
            <div class="notification-badge" id="notificationBadge">3</div>
        </div>
    </div>


    <!-- Notification Container -->
    <div class="notification-container">
        <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
                <h3>NOTIFICATIONS</h3>
            </div>
            <div class="notification-list" id="notificationList"></div>
            <div class="notification-footer">
                <button class="btn-clear-all" onclick="clearAllNotifications()">Clear All</button>
            </div>
        </div>
    </div>


    <!-- Hidden element to store Pok√©mon data -->
    <div id="pokemonDataStorage" data-pokemons='{{ pokemons|tojson|safe }}' style="display: none;"></div>


    <div class="dashboard-container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1>Hello, Trainer!</h1>
        </div>


        <!-- Word of the Day Section -->
        <div class="word-of-day-section">
            <div class="word-of-day-header">
                <h2 class="word-of-day-title">üìö WORD OF THE DAY</h2>
                <div class="word-date" id="currentDate"></div>
            </div>
            <table class="word-table">
                <thead>
                    <tr>
                        <th>WORD</th>
                        <th>PRONUNCIATION</th>
                        <th>TYPE</th>
                        <th>MEANING</th>
                        <th>EXAMPLE</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="word-main" id="wordOfDay">Ephemeral</span></td>
                        <td><span class="word-pronunciation" id="wordPronunciation">/…™Ààf…õm…ôr…ôl/</span></td>
                        <td><span class="word-type" id="wordType">Adjective</span></td>
                        <td id="wordMeaning">Lasting for a very short time; transient.</td>
                        <td><div class="word-example" id="wordExample">"The beauty of cherry blossoms is ephemeral, lasting only a few days each spring."</div></td>
                    </tr>
                </tbody>
            </table>
            <div class="word-actions">
                <button class="btn-save-word" onclick="saveWordOfTheDay()">‚ûï Save to Collection</button>
            </div>
        </div>


        <!-- Navigation -->
        <div class="nav-row">
            <div class="nav-item" onclick="window.location.href='/review'"><div class="icon">üìñ</div><h3>Review Now</h3></div>
            <div class="nav-item" onclick="window.location.href='/wordbank'"><div class="icon">üìù</div><h3>My Words</h3></div>
            <div class="nav-item" onclick="window.location.href='/add_word'"><div class="icon">‚ûï</div><h3>ADD NEW WORD</h3></div>
        </div>


        <!-- Progress Section -->
        <div class="progress-section">
            <div class="progress-card">
                <h2>Your Progress</h2>
                <div class="progress-stat">
                    <span class="label">Words Learned This Week</span>
                    <span class="value">{{ weekly_total }}</span>
                </div>
                <div class="progress-stat">
                    <span class="label">Current Streak</span>
                    <span class="value">{{ streak }} Days</span>
                </div>
                <div class="progress-stat">
                    <span class="label">Pok√©mon Evolutions</span>
                    <span class="value">{{ evolutions }}</span>
                </div>
                <div class="progress-stat">
                    <span class="label">Accuracy Rate</span>
                    <span class="value">{{ accuracy }}%</span>
                </div>
                <button class="btn-secondary" onclick="window.location.href='/progress'">VIEW DETAILED PROGRESS</button>
            </div>


            <div class="progress-card">
                <h2>All Time Ranking</h2>
                <div class="progress-stat">
                    <span class="label">Total Points</span>
                    <span class="value">{{ total_points }}</span>
                </div>
                <button class="btn-secondary" onclick="window.location.href='/leaderboard'">VIEW LEADERBOARD</button>
            </div>
        </div>
    </div>


    <!-- Starter Modal -->
    {% if showStarterModal %}
    <div class="modal active" id="welcomeModal">
        <div class="modal-content">
            <h2>Welcome to VocabuLearner!</h2>
            <p>Start your vocabulary journey today! Explore the dashboard to add words, review your collection, and track your progress.</p>
            <p>First, choose your Pok√©mon partner to accompany you on your learning adventure!</p>
            <button class="btn-confirm" onclick="openPokemonModal()">Choose Your Pok√©mon Partner!</button>
        </div>
    </div>


    <div class="pokemon-modal" id="pokemonModal">
        <div class="pokemon-modal-content">
            <h2>Choose Your Learning Partner!</h2>
            <p>Select your Pok√©mon partner who will accompany you on your vocabulary journey.</p>
            <div class="pokemon-grid" id="pokemonGrid"></div>
            <form action="{{ url_for('choose_partner') }}" method="POST" style="margin-top: 30px;">
                <input type="hidden" name="pokemon_id" id="selectedPokemonId">
                <button type="submit" class="btn-confirm">
                    Start Learning with <span id="selectedPartnerName">Pikachu</span>!
                </button>
            </form>
        </div>
    </div>
    {% endif %}


    <footer class="footer">
        <p>¬© 2025 VocabuLearner</p>
    </footer>


    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const pokemonData = JSON.parse(document.getElementById("pokemonDataStorage").dataset.pokemons);
            const grid = document.getElementById("pokemonGrid");
            const selectedIdInput = document.getElementById("selectedPokemonId");
            const selectedNameSpan = document.getElementById("selectedPartnerName");

            // Filter only starter Pok√©mon and limit to 6 (3x2)
            const starters = pokemonData.filter(p => p.rarity === "starter").slice(0, 6);

            starters.forEach(p => {
                const card = document.createElement("div");
                card.className = "pokemon-card";
                card.innerHTML = `
                    <img src="${p.img}" alt="${p.name}" class="pokemon-sprite">
                    <p>${p.name}</p>
                `;
                card.addEventListener("click", () => {
                    document.querySelectorAll(".pokemon-card").forEach(c => c.classList.remove("selected"));
                    card.classList.add("selected");

                    selectedIdInput.value = p.id;
                    selectedNameSpan.textContent = p.name;
                });
                grid.appendChild(card);
            });

            // Load notifications on page init
            loadNotifications();
        });

        function openPokemonModal() {
            document.getElementById('welcomeModal').classList.remove('active');
            document.getElementById('pokemonModal').classList.add('active');
        }
        function closePokemonModal() {
            document.getElementById('pokemonModal').classList.remove('active');
        }

        // --- Notification Methods ---
        function loadNotifications() {
            const notificationList = document.getElementById('notificationList');
            notificationList.innerHTML = '';
            
            let unreadCount = 0;
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="no-notifications">No notifications yet!</div>';
                document.getElementById('notificationBadge').textContent = '0';
                document.getElementById('notificationBadge').style.display = 'none';
                return;
            }
            
            notifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = "notification-item ${notification.unread ? 'unread' : ''}";
                item.onclick = () => markAsRead(notification.id);
                
                item.innerHTML = `
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${notification.time}</div>
                `;
                
                notificationList.appendChild(item);
                
                if (notification.unread) {
                    unreadCount++;
                }
            });
            
            // Update badge count
            document.getElementById('notificationBadge').textContent = unreadCount;
            if (unreadCount > 0) {
                document.getElementById('notificationBadge').style.display = 'flex';
            } else {
                document.getElementById('notificationBadge').style.display = 'none';
            }
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('active');
        }

        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification && notification.unread) {
                notification.unread = false;
                loadNotifications();
            }
        }

        function clearAllNotifications() {
            if (notifications.length === 0) {
                alert("There are no notifications to clear!");
                return;
            }
            
            if (confirm('Are you sure you want to clear all notifications?')) {
                notifications = [];
                loadNotifications();
                toggleNotifications();
                alert("All notifications have been cleared!");
            }
        }
    </script>
{% endblock %}



