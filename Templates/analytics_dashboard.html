{%extends "base.html"%}
    {%block title%}
        <title>Analytics Dashboard - VocabuLearner Admin</title>
    {%endblock%}




    {%block content%}
    {%block logo_link %}
                <a href="{{ url_for('admin_dashboard') }}" class="logo-link">
                    <div class="logo-icon">
                        <div class="pokeball-mini"></div>
                        <div class="pokeball-mini"></div>
                        <div class="pokeball-mini"></div>
                    </div>
                    VocabuLearner
                </a>
        {% endblock %}
        {%block header%}
            <div class="header-actions">
                <button class="back-btn1" onclick="goToDashboard()">Back to Dashboard</button>
                <button class="logout-btn" onclick="showLogoutConfirm()">Logout</button>
            </div>
        {%endblock%}
        <style>
            /* Analytics Dashboard Styles */
            .dashboard-container {
                margin-top: 120px;
                max-width: 1400px;
                margin-left: auto;
                margin-right: auto;
                padding: 20px;
                position: relative;
                z-index: 10;
            }


            .back-btn1 {
            background: #4169e1;
            color: #fff;
            border: 3px solid #000;
            padding: 8px 15px;
            font-size: 10px;
            box-shadow: 4px 4px 0 #000;
            cursor: pointer;
            text-transform: uppercase;
            font-family: 'Press Start 2P', monospace;
            transition: all 0.2s;
        }
        .back-btn1:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
            background: #3558c7;
        }

            /* Page Header */
            .page-header {
                background: rgba(255,255,255,0.15);
                backdrop-filter: blur(10px);
                border: 4px solid #000;
                padding: 25px;
                margin-bottom: 30px;
                box-shadow: 8px 8px 0 #000;
                text-align: center;
            }
            .page-header h1 {
                font-size: 24px;
                color: #ffd700;
                text-shadow: 4px 4px 0 #000;
                margin-bottom: 15px;
            }
            .page-header p {
                font-size: 12px;
                color: #fff;
                text-shadow: 2px 2px 0 #000;
                margin-bottom: 20px;
            }




            /* Date Filter */
            .date-filter {
                background: rgba(255,255,255,0.15);
                backdrop-filter: blur(10px);
                border: 4px solid #000;
                padding: 20px;
                margin-bottom: 30px;
                box-shadow: 8px 8px 0 #000;
                display: flex;
                gap: 20px;
                align-items: center;
                justify-content: center;
                flex-wrap: wrap;
            }
            .date-label {
                font-size: 10px;
                color: #ffd700;
                text-shadow: 2px 2px 0 #000;
            }
            .date-input {
                padding: 10px;
                border: 3px solid #000;
                background: rgba(255,255,255,0.9);
                font-family: 'Press Start 2P', monospace;
                font-size: 10px;
                box-shadow: 4px 4px 0 #000;
                min-width: 150px;
            }
            .date-range {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            /* Error Message */
            .error-message {
                background: rgba(255,68,68,0.9);
                border: 3px solid #000;
                padding: 10px;
                margin-bottom: 20px;
                box-shadow: 4px 4px 0 #000;
                text-align: center;
                display: none;
            }
            .error-message p {
                font-size: 10px;
                color: #fff;
                text-shadow: 1px 1px 0 #000;
                margin: 0;
                font-family: 'Press Start 2P', monospace;
            }




            /* Platform Statistics Graph */
            .platform-graph-container {
                background: rgba(255,255,255,0.15);
                backdrop-filter: blur(10px);
                border: 4px solid #000;
                padding: 30px;
                margin-bottom: 30px;
                box-shadow: 8px 8px 0 #000;
            }




            .platform-graph-container h2 {
                font-size: 20px;
                color: #ffd700;
                text-shadow: 3px 3px 0 #000;
                margin-bottom: 20px;
                text-align: center;
                border-bottom: 3px solid #ffd700;
                padding-bottom: 10px;
            }




            .graph-wrapper {
                display: flex;
                align-items: flex-end;
                justify-content: center;
                padding: 20px 0 0 0;
                gap: 60px;
                position: relative;
                min-height: 250px;
            }




            .graph-bar {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 120px;
                position: relative;
            }




            /* TOP SECTION: Just the category labels */
            .bar-top-section {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 10px;
            }




            .bar-label {
                font-size: 12px;
                color: #ffd700;
                text-shadow: 2px 2px 0 #000;
                text-align: center;
                margin-bottom: 5px;
            }




            /* MIDDLE SECTION: Just the graph bars */
            .bar-graph-section {
                height: 200px;
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: center;
            }




            .bar-container {
                width: 80px;
                height: 200px;
                background: rgba(0,0,0,0.3);
                border: 3px solid #000;
                position: relative;
                overflow: hidden;
            }




            .bar-fill {
                position: absolute;
                bottom: 0;
                width: 100%;
                transition: height 1.5s ease-out;
                border-top: 3px solid #000;
            }




            .bar-fill.hours {
                background: linear-gradient(to top, #4169e1, #5fcde4);
                height: 0;
            }




            .bar-fill.words {
                background: linear-gradient(to top, #76c442, #a8e063);
                height: 0;
            }




            /* BOTTOM SECTION: Numbers and percentage labels below the graph */
            .bar-bottom-section {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-top: 15px;
                min-height: 60px;
                gap: 5px;
            }




            .bar-value {
                font-size: 16px;
                font-weight: bold;
                color: #fff;
                text-shadow: 2px 2px 0 #000;
                text-align: center;
                min-width: 60px;
            }




            .bar-trend {
                font-size: 9px;
                color: #76c442;
                text-shadow: 1px 1px 0 #000;
                text-align: center;
                line-height: 1.2;
                min-height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }




            .graph-legend {
                display: flex;
                justify-content: center;
                gap: 30px;
                margin-top: 40px;
                padding-top: 20px;
                border-top: 2px dashed rgba(255,255,255,0.3);
            }




            .legend-item {
                display: flex;
                align-items: center;
                gap: 10px;
            }




            .legend-color {
                width: 20px;
                height: 20px;
                border: 2px solid #000;
            }




            .legend-text {
                font-size: 10px;
                color: #fff;
                text-shadow: 1px 1px 0 #000;
            }




            /* Improved Analytics Tables */
            .analytics-tables {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .table-container {
                background: rgba(255,255,255,0.15);
                backdrop-filter: blur(10px);
                border: 4px solid #000;
                padding: 25px;
                box-shadow: 8px 8px 0 #000;
            }
            .table-container h2 {
                font-size: 18px;
                color: #ffd700;
                text-shadow: 3px 3px 0 #000;
                margin-bottom: 10px;
                text-align: center;
                border-bottom: 3px solid #ffd700;
                padding-bottom: 10px;
            }
            
            .table-description {
                font-size: 10px;
                color: #ffd700;
                text-align: center;
                margin-bottom: 20px;
                text-shadow: 1px 1px 0 #000;
                font-family: 'Press Start 2P', monospace;
                line-height: 1.5;
            }
            
            .analytics-table {
                width: 100%;
                border-collapse: collapse;
                border: 3px solid #000;
            }
            
            .analytics-table thead {
                background: rgba(0,0,0,0.4);
                border-bottom: 4px solid #ffd700;
            }
            
            .analytics-table th {
                padding: 16px 12px;
                text-align: left;
                font-size: 16px;
                color: #ffd700;
                text-shadow: 2px 2px 0 #000;
                font-weight: bold;
                letter-spacing: 0.5px;
                border-right: 2px solid rgba(255,255,255,0.1);
            }
            
            .analytics-table th:last-child {
                border-right: none;
            }
            
            .analytics-table td {
                padding: 14px 12px;
                font-size: 14px;
                color: #fff;
                text-shadow: 1px 1px 0 #000;
                border-bottom: 2px solid rgba(255,215,0,0.2);
                font-family: 'Press Start 2P', monospace;
                line-height: 1.4;
            }
            
            .analytics-table tr:nth-child(even) {
                background: rgba(0,0,0,0.1);
            }
            
            .analytics-table tr:nth-child(odd) {
                background: rgba(0,0,0,0.05);
            }
            
            .analytics-table tr:hover {
                background: rgba(255,215,0,0.1);
                transition: background 0.3s ease;
            }
            
            /* Column-specific styling */
            .analytics-table td:first-child {
                font-weight: bold;
                color: #ffffff;
            }
            
            .analytics-table td:nth-child(2) {
                color: #ffffff;
                font-weight: bold;
                text-align: center;
            }
            
            .analytics-table td:nth-child(3) {
                color: #ffffff;
                font-weight: bold;
                text-align: center;
            }
            
            .analytics-table td:nth-child(4) {
                color: #f8ff6b;
                font-weight: bold;
                text-align: center;
            }




            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 2000;
                justify-content: center;
                align-items: center;
            }
            .modal.active {
                display: flex;
            }
            .modal-content {
                background: rgba(255,255,255,0.95);
                backdrop-filter: blur(10px);
                border: 4px solid #000;
                padding: 40px;
                max-width: 500px;
                width: 90%;
                box-shadow: 12px 12px 0 #000;
                text-align: center;
            }
            .modal-content h2 {
                font-size: 20px;
                color: #228b22;
                text-shadow: 3px 3px 0 #ffd700;
                margin-bottom: 20px;
            }
            .modal-content p {
                font-size: 12px;
                color: #000;
                margin-bottom: 20px;
                line-height: 1.6;
            }
            .modal-actions {
                display: flex;
                gap: 10px;
                justify-content: center;
                margin-top: 20px;
            }
            .btn-confirm {
                background: #76c442;
                color: #fff;
                border: 4px solid #000;
                padding: 12px 25px;
                font-size: 12px;
                box-shadow: 6px 6px 0 #000;
                cursor: pointer;
                font-family: 'Press Start 2P', monospace;
            }
            .btn-cancel {
                background: #ff4444;
                color: #fff;
                border: 4px solid #000;
                padding: 12px 25px;
                font-size: 12px;
                box-shadow: 6px 6px 0 #000;
                cursor: pointer;
                font-family: 'Press Start 2P', monospace;
            }
            .btn-confirm:hover, .btn-cancel:hover {
                transform: translate(3px, 3px);
                box-shadow: 3px 3px 0 #000;
            }




            /* Button Styles */
            .action-btn {
                background: #4169e1;
                color: #fff;
                border: 4px solid #000;
                padding: 10px 20px;
                font-size: 10px;
                box-shadow: 6px 6px 0 #000;
                cursor: pointer;
                font-family: 'Press Start 2P', monospace;
                transition: all 0.2s;
            }
            .action-btn:hover {
                transform: translate(3px, 3px);
                box-shadow: 3px 3px 0 #000;
            }
            .action-btn.secondary {
                background: #76c442;
            }
            .action-btn.tertiary {
                background: #ffd700;
                color: #000;
            }
            .action-btn.export {
                background: #ff6b6b;
                color: #fff;
            }
            .action-btn.export:hover {
                background: #ff4444;
            }
            /* Add red clear button */
            .action-btn.red-clear {
                background: #ff4444;
            }
            .action-btn.red-clear:hover {
                background: #cc0000;
            }




            /* Loading State */
            .loading {
                opacity: 0.7;
                pointer-events: none;
            }




            /* Responsive adjustments */
            @media (max-width: 900px) {
                .analytics-tables {
                    grid-template-columns: 1fr;
                }
                
                .analytics-table th {
                    font-size: 10px;
                    padding: 14px 10px;
                }
                
                .analytics-table td {
                    font-size: 9px;
                    padding: 12px 10px;
                }
                
                .table-container h2 {
                    font-size: 16px;
                }
                
                .table-description {
                    font-size: 9px;
                }




                .date-filter {
                    flex-direction: column;
                    align-items: stretch;
                }




                .date-range {
                    flex-direction: column;
                    align-items: stretch;
                }




                .header-actions {
                    flex-wrap: wrap;
                    justify-content: flex-end;
                }




                .graph-wrapper {
                    gap: 30px;
                }




                .graph-bar {
                    width: 90px;
                }




                .bar-container {
                    width: 60px;
                    height: 150px;
                }
               
                .bar-graph-section {
                    height: 150px;
                }
            }




            @media (max-width: 600px) {
                .graph-wrapper {
                    flex-direction: column;
                    align-items: center;
                    gap: 40px;
                }
                
                .analytics-table {
                    display: block;
                    overflow-x: auto;
                }
                
                .analytics-table th,
                .analytics-table td {
                    min-width: 120px;
                    white-space: nowrap;
                }
                
                .table-container h2 {
                    font-size: 14px;
                }




                .graph-bar {
                    width: 100%;
                    max-width: 200px;
                }




                .bar-container {
                    height: 120px;
                }
               
                .bar-graph-section {
                    height: 120px;
                }
            }
        </style>




        <div class="dashboard-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>Analytics Dashboard</h1>
                <p>Platform statistics and user performance metrics</p>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="dateError">
                <p>‚ùå Error: "Date From" cannot be greater than "Date To"</p>
            </div>




            <!-- Date Filter Form -->
            <form method="POST" action="{{ url_for('admin_analytics') }}" class="date-filter" id="dateFilterForm">
                <span class="date-label">Date Range:</span>
                <div class="date-range">
                    <input type="date" class="date-input" id="dateFrom" name="date_from"
                           value="{{ date_from.strftime('%Y-%m-%d') }}" required>
                    <span class="date-label">to</span>
                    <input type="date" class="date-input" id="dateTo" name="date_to"
                           value="{{ date_to.strftime('%Y-%m-%d') }}" required>
                </div>
               
                <!-- Submit button for form submission -->
                <button type="submit" class="action-btn" id="applyFilterBtn">Apply</button>
               
                <!-- JavaScript buttons -->
                <button type="button" class="action-btn secondary" onclick="resetDateFilter()">This Month</button>
                <button type="button" class="action-btn red-clear" onclick="clearFilter()">Clear</button>
               
                <!-- Export Data Button -->
                <button type="button" class="action-btn export" onclick="exportAnalyticsData()">
                    üìä Export Data
                </button>
            </form>




            <!-- Platform Statistics Graph -->
            <div class="platform-graph-container">
                <h2>Platform Statistics</h2>
           
                <div class="graph-wrapper">
                    <div class="graph-bar">
                        <!-- TOP: Just the category label -->
                        <div class="bar-top-section">
                            <div class="bar-label">Total Users</div>
                        </div>
                       
                        <!-- MIDDLE: Graph bars only -->
                        <div class="bar-graph-section">
                            <div class="bar-container">
                                <div class="bar-fill hours" id="hours-bar"></div>
                            </div>
                        </div>
                       
                        <!-- BOTTOM: Numbers and percentage labels below the graph -->
                        <div class="bar-bottom-section">
                            <div class="bar-value" id="hours-value">{{ total_users }}</div>
                            <div class="bar-trend"></div>
                        </div>
                    </div>
               
                    <div class="graph-bar">
                        <!-- TOP: Just the category label -->
                        <div class="bar-top-section">
                            <div class="bar-label">Words Stored</div>
                        </div>
                       
                        <!-- MIDDLE: Graph bars only -->
                        <div class="bar-graph-section">
                            <div class="bar-container">
                                <div class="bar-fill words" id="words-bar"></div>
                            </div>
                        </div>
                       
                        <!-- BOTTOM: Numbers and percentage labels below the graph -->
                        <div class="bar-bottom-section">
                            <div class="bar-value" id="words-value">{{ total_words }}</div>
                            <div class="bar-trend"></div>
                        </div>
                    </div>
                </div>
           
                <div class="graph-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4169e1;"></div>
                        <span class="legend-text">Total Users ({{ total_users }})</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #76c442;"></div>
                        <span class="legend-text">Words Stored ({{ total_words }})</span>
                    </div>
                </div>
            </div>




            <!-- Analytics Tables (Only Top Performing Users) -->
            <div class="analytics-tables">
                <div class="table-container">
                    <h2>Top Performing Users ({{ date_from.strftime('%Y-%m-%d') }} to {{ date_to.strftime('%Y-%m-%d') }})</h2>
                    <p class="table-description">
                        Showing the most active users based on words stored during this period
                    </p>
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Words Stored</th>
                                <th>Streak</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody id="topUsersTable">
                            {% for user in top_users %}
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>{{ user.words_stored }}</td>
                                <td>{{ user.streak }}</td>
                                <td>{{ user.points }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>




        <!-- Logout Modal -->
        <div class="modal" id="logoutModal">
            <div class="modal-content">
                <h2>Confirm Logout</h2>
                <p>Are you sure you want to logout?</p>
                <div class="modal-actions">
                    <button class="btn-confirm" onclick="performLogout()">Yes, Logout</button>
                    <button class="btn-cancel" onclick="closeModal('logoutModal')">Cancel</button>
                </div>
            </div>
        </div>




        <footer class="footer">
            <p>¬© 2025 VocabuLearner - Analytics Dashboard v1.0</p>
        </footer>




        <script>
            // Navigation Functions
            function goToDashboard() {
                window.location.href = "{{ url_for('admin_dashboard') }}";
            }




            function showLogoutConfirm() {
                document.getElementById('logoutModal').classList.add('active');
            }




            function performLogout() {
                // Redirect to Flask logout route
                window.location.href = "{{ url_for('logout') }}";
            }




            // Modal Functions
            function showModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            }




            function closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            // Date validation function
            function validateDates() {
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const errorElement = document.getElementById('dateError');
                
                if (dateFrom && dateTo && new Date(dateFrom) > new Date(dateTo)) {
                    errorElement.style.display = 'block';
                    return false;
                } else {
                    errorElement.style.display = 'none';
                    return true;
                }
            }

            // Add event listeners for date validation
            document.getElementById('dateFrom').addEventListener('change', validateDates);
            document.getElementById('dateTo').addEventListener('change', validateDates);




            // Form submission handler for AJAX
            document.getElementById('dateFilterForm').addEventListener('submit', function(e) {
                // Prevent default form submission if JavaScript is enabled
                e.preventDefault();
                
                // Validate dates before submitting
                if (!validateDates()) {
                    alert('Error: "Date From" cannot be greater than "Date To"');
                    return;
                }
                
                submitFilterFormAjax();
            });




        function submitFilterFormAjax() {
            const form = document.getElementById('dateFilterForm');
            
            // Validate dates first
            if (!validateDates()) {
                alert('Error: "Date From" cannot be greater than "Date To"');
                return;
            }
            
            // Convert FormData to JSON
            const data = {
                date_from: document.getElementById('dateFrom').value,
                date_to: document.getElementById('dateTo').value
            };
            
            // Use the API endpoint (NO LOADING STATE)
            fetch('/admin/api/analytics/filter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(responseData => {
                if (responseData.success) {
                    // Update the UI with the new data
                    const data = responseData.data;
                    updateAnalyticsUI(data);
                    
                    // Update form date inputs to reflect what was actually used
                    document.getElementById('dateFrom').value = data.date_from;
                    document.getElementById('dateTo').value = data.date_to;
                } else {
                    alert('Error: ' + responseData.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error. Please try again. Check console for details.');
            });
            // NO LOADING STATE - button stays as "Apply"
        }



        function resetDateFilter() {
            // Get current time in Philippine Time
            const now = new Date();
            
            // Convert to Philippine Time
            const philippineTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Manila"}));
            
            // Get first day of current month in Philippine Time
            const firstDay = new Date(philippineTime.getFullYear(), philippineTime.getMonth(), 1);
            
            // Format dates as YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('dateFrom').value = formatDate(firstDay);
            document.getElementById('dateTo').value = formatDate(philippineTime);
            
            // Submit via AJAX
            submitFilterFormAjax();
        }

            function clearFilter() {
                // Create date in Philippine Time
                const now = new Date();

                const philippineTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Manila"}));
                
                // Format dates as YYYY-MM-DD
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                // Set both dates to today in Philippine Time
                document.getElementById('dateFrom').value = formatDate(philippineTime);
                document.getElementById('dateTo').value = formatDate(philippineTime);
                
                // Submit via AJAX
                submitFilterFormAjax();
            }




            // Export Analytics Function
            function exportAnalyticsData() {
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
               
                // Validate dates before exporting
                if (!validateDates()) {
                    alert('Error: "Date From" cannot be greater than "Date To"');
                    return;
                }
               
                if (!dateFrom || !dateTo) {
                    alert('Please select a date range before exporting.');
                    return;
                }
               
                // Show loading state
                const exportBtn = document.querySelector('button[onclick="exportAnalyticsData()"]');
                const originalText = exportBtn.textContent;
                exportBtn.textContent = 'Exporting...';
                exportBtn.disabled = true;
               
                // Make request to export endpoint
                fetch('/admin/analytics/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        date_from: dateFrom,
                        date_to: dateTo
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Export failed');
                    }
                    return response.text();
                })
                .then(textData => {
                    // Create download link for .txt file with simple format
                    const blob = new Blob([textData], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `analytics_${dateFrom}_to_${dateTo}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                   
                    // Show success message
                    alert('Analytics data exported successfully!');
                })
                .catch(error => {
                    console.error('Export error:', error);
                    alert('Failed to export analytics data. Please try again.');
                })
                .finally(() => {
                    // Reset button state
                    exportBtn.textContent = originalText;
                    exportBtn.disabled = false;
                });
            }




            function updateAnalyticsUI(data) {
                // Update statistics
                document.getElementById('hours-value').textContent = data.total_users;
                document.getElementById('words-value').textContent = data.total_words;
                
                // Clear trend labels
                const barTrends = document.querySelectorAll('.bar-trend');
                barTrends.forEach(trend => {
                    trend.textContent = '';
                });
                
                // Update legend
                const legendItems = document.querySelectorAll('.legend-text');
                if (legendItems[0]) legendItems[0].textContent = `Total Users (${data.total_users})`;
                if (legendItems[1]) legendItems[1].textContent = `Words Stored (${data.total_words})`;
                
                // Update top users table
                const tableBody = document.getElementById('topUsersTable');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    
                    data.top_users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.words_stored}</td>
                            <td>${user.streak}</td>
                            <td>${user.points || 0}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Update table title with date range
                    const tableTitle = document.querySelector('.table-container h2');
                    if (tableTitle && data.date_from && data.date_to) {
                        tableTitle.textContent = `Top Performing Users (${data.date_from} to ${data.date_to})`;
                    }
                    
                    // Update table description
                    const tableDesc = document.querySelector('.table-description');
                    if (tableDesc) {
                        tableDesc.textContent = `Showing the most active users based on words stored during this period`;
                    }
                }
                
                // Re-animate graph with new values
                animateGraph();
            }




            // Graph Animation Functions
            function animateGraph() {
                // Get actual values from the page elements
                const totalUsers = parseInt(document.getElementById('hours-value').textContent) || 0;
                const totalWords = parseInt(document.getElementById('words-value').textContent) || 0;
               
                // Calculate percentages based on max value
                const maxValue = Math.max(totalUsers, totalWords) || 1;
               
                const usersPercent = Math.min((totalUsers / maxValue) * 95, 95);
                const wordsPercent = Math.min((totalWords / maxValue) * 95, 95);
               
                // Animate the bars
                setTimeout(() => {
                    const hoursBar = document.getElementById('hours-bar');
                    if (hoursBar) hoursBar.style.height = `${usersPercent}%`;
                }, 300);
               
                setTimeout(() => {
                    const wordsBar = document.getElementById('words-bar');
                    if (wordsBar) wordsBar.style.height = `${wordsPercent}%`;
                }, 600);
            }




            // Close modals when clicking outside
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.classList.remove('active');
                }
            };




            // Set default date values and animate graph
            window.onload = function() {
                // Animate graph after page loads
                setTimeout(animateGraph, 500);
               
                // Add form submission handler
                const form = document.getElementById('dateFilterForm');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        // Validate dates before submitting
                        if (!validateDates()) {
                            alert('Error: "Date From" cannot be greater than "Date To"');
                            return;
                        }
                        
                        submitFilterFormAjax();
                    });
                }
                
                // Initialize date validation
                validateDates();
            };
        </script>
    {%endblock%}